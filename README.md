# hardml_mlops_final

Сервис состоит из следующих сервисов:
- tf_serving - сервинг USE модели через образ TensorFlow
- gateway - сервис, принимает запрос в виде {"query": "тут_запрос"} и отвечает похожим запросом
- index_service_0, index_service_1, index_service_2, index_service_3 - сервисы, соответствующие кластерам индексов, принимают на вход эмбеддинги и возвращают похожий запрос, который в дальнейшем возвращается сервису gateway.

# Deploy
1) git clone https://github.com/dobretz/hardml_mlops_final.git - скопировать репозиторий на все сервера
2) cd scripts
3) ./build_all.sh - создание докер образов
4) ./docker_registry.sh - залив докер образов в registry
5) cd ..
6) ./start.sh
... Сервис запущен, можно обращаться по адресу  http://95.217.236.128:14005/input ...
Запрос через Postman, пример запроса
{"query": "example"}
Пример ответа:
{
"best_match": "Has Ancient Japan been scientifically tested?",
"cluster": "0"
}

# Обновление индексов
1) Индексы уже сделаны легче (только по 1000 предложений) и готовы в папке dgs, в серверах уже были загружены через git (альтернативный метод доставки описан в scripts/delivery.sh)
2) cd scripts
3) ./update_indices.sh - лучше запустить с компьютера, где есть доступ к обеим серверам (в моем случае это локалка)
... Через некоторое время индексы обновятся, сервисы поднимутся и все будет ок ...
- Бесшовное обновление индексов и центров кластеров будет обеспечено за счет загрузки их в память

# Контрольные вопросы
1. Точно ли вы подняли все, что нужно QA системе? Если вы закодили все внутри одного приложения, то это не зачтется :(
- Да: tf-serving, gateway, index_service_0, index_service_1, index_service_2, index_service_3

2. Каким образом файлы с индексами попадают на целевые машины? Попадают ли индексы адресно или происходит broadcast одного файла на все сервера?
- Происходит broadcast одной папки на все сервера

3. Написали ли ли вы стратегию обновления индекса в системе? Что это за стратегия: Blue / Green или Rolling? А есть ли у вашей стратегии downtime?
- Rolling_update через docker service. Да, 30 секунд.

4. При обновлении индекса обновляются ли необходимые параметры в других частях системы?Т.е. не случится ли такого, что gateway направляет запрос не на тот индекс если во время обновления что то пошло не так? Не забыли ли вы про идемпотентность обновлений в вашей стратегии?
- Обновляются центры кластеров. Запрос не может попасть на другой индекс, надеюсь docker-swarm такого не допустит. Идемпотентность одноразовая есть, если все делать по инструкции должен получаться одинаковый результат.

5. Что будет, если индекс не сможет обновиться? (например, попался битый файл индекса)
- Скорее всего все сломается, этот сценарий не проработан

6. Может, вы не поленились и предусмотрели ли какие нибудь failover?
- Не предусмотрел

7. Вы использовали уже готовые инструменты, знакомые многим или решили написали свой shellсипед?
- Свой shellсипед
   
8. А что с самими приложениями сервинга? Нет перегружен ли его запуск внешними зависимостями, правильно ли выключается и поднимается приложение. Существует способ быстро проверить здорово ли приложение?
- Да, можно поднять его локально. Для этого есть docker-compose.yml и docker-compose_remote.yml. Для локального запуска нужен первый файл
- Достаточно команд docker-compose build и docker-compose up. Все необходимое поднимется и можно слать запросы на gateway localhost:14005
- Нужны папки /indices и /use - индексы и модель USE соответственно. Нужно распаковать архив upload.zip в корневую папку проекта https://drive.google.com/file/d/1mXVCo-pavMUw3mlKbn4CBSE6wyqQw7D9/view?usp=sharing