# hardml_mlops_final

Сервис состоит из следующих сервисов:
- tf_serving - сервинг USE модели через образ TensorFlow
- gateway - сервис, принимает запрос в виде {"query": "тут_запрос"} и отвечает похожим запросом
- index_service_0, index_service_1, index_service_2, index_service_3 - сервисы, соответствующие кластерам индексов, принимают на вход эмбеддинги и возвращают похожий запрос, который в дальнейшем возвращается сервису gateway.

# Deploy
Запуск через команду:
docker stack deploy --compose-file docker-compose_remote.yml pairsstack

Заранее должны быть загружены образы сервисов gateway и index_service в docker registry.
Также должен быть настроен и готов docker-swarm кластер с manager и worker нодой.
Рекомендуется заранее закачать через scp на сервер индексы по адресу /opt/indices/ и модель USE в /opt/models/

# Обновление индексов
1) Нужно загрузить необходимые данные в папку data/clusters_use_dg{dg}.json и data/use_embeddings_dg{dg}.pkl
2) Нужно запустить скрипт scripts/file_splitter.py
3) Затем будут созданы файлы в папке /dgs
4) Далее эти файлы нужно через скрипт delivery.sh заброадкастить на все сервера в docker-swarm кластере
5) Скрипт update_indices.sh запустит rolling-update сервисов в докере

# Контрольные вопросы
1. Точно ли вы подняли все, что нужно QA системе? Если вы закодили все внутри одного приложения, то это не зачтется :(
- Да: tf-serving, gateway, index_service_0, index_service_1, index_service_2, index_service_3

2. Каким образом файлы с индексами попадают на целевые машины? Попадают ли индексы адресно или происходит broadcast одного файла на все сервера?
- Происходит broadcast одной папки на все сервера

3. Написали ли ли вы стратегию обновления индекса в системе? Что это за стратегия: Blue / Green или Rolling? А есть ли у вашей стратегии downtime?
- Rolling_update через docker service. Да, 30 секунд.

4. При обновлении индекса обновляются ли необходимые параметры в других частях системы?Т.е. не случится ли такого, что gateway направляет запрос не на тот индекс если во время обновления что то пошло не так? Не забыли ли вы про идемпотентность обновлений в вашей стратегии?
- Обновляются центры кластеров. Запрос не может попасть на другой индекс, надеюсь docker-swarm такого не допустит. Идемпотентность одноразовая есть, если все делать по инструкции должен получаться одинаковый результат.

5. Что будет, если индекс не сможет обновиться? (например, попался битый файл индекса)
- Скорее всего все сломается, этот сценарий не проработан

6. Может, вы не поленились и предусмотрели ли какие нибудь failover?
- Не предусмотрел

7. Вы использовали уже готовые инструменты, знакомые многим или решили написали свой shellсипед?
- Свой shellсипед
   
8. А что с самими приложениями сервинга? Нет перегружен ли его запуск внешними зависимостями, правильно ли выключается и поднимается приложение. Существует способ быстро проверить здорово ли приложение?
- Да, можно поднять его локально. Для этого есть docker-compose.yml и docker-compose_remote.yml. Для локального запуска нужен первый файл
- Достаточно команд docker-compose build и docker-compose up. Все необходимое поднимется и можно слать запросы на gateway localhost:14005
- Нужны папки /indices и /use - индексы и модель USE соответственно. Нужно распаковать архив upload.zip в корневую папку проекта